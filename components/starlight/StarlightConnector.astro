---

---

<script>
	import { openCategory, updateCurrentPageMarker } from './utils';
	import * as STARLIGHT from './utils';

	export const REPLACE_SIDEBAR_CONTENT = 'vtbot-starlight-replace-sidebar-content';
	export const RETAIN_CURRENT_PAGE_MARKER = 'vtbot-starlight-retain-current-page-marker';

	const queryMarkers = () => ({
		replaceSidebarContent: document.querySelector(`head meta[name="${REPLACE_SIDEBAR_CONTENT}"]`),
		retainCurrentPageMarker: document.querySelector(
			`head meta[name="${RETAIN_CURRENT_PAGE_MARKER}"]`
		),

		mainTransitionScope: document.querySelector<HTMLMetaElement>(
			'head meta[name="vtbot-main-transition-scope"]'
		)?.content,
	});
	let { replaceSidebarContent, retainCurrentPageMarker, mainTransitionScope } = queryMarkers();

	openCategory();
	updateLanguageSelector(window.document);

	function afterLoader(e: TransitionBeforePreparationEvent) {
		markMainFrameForReplacementSwap(document);
		markMainFrameForReplacementSwap(e.newDocument);
		closeMobileMenu();
		updateLanguageSelector(e.newDocument);
		setMainTransitionScope(e);
		!replaceSidebarContent && !retainCurrentPageMarker && updateCurrentPageMarker(e.to);
	}

	function afterSwap(e: TransitionBeforeSwapEvent) {
		updateSidebar(e);
		!retainCurrentPageMarker && openCategory();
	}

	/* ---------------- */

	function closeMobileMenu() {
		if (document.body.hasAttribute(STARLIGHT.MOBILE_MENU_EXPANDED)) {
			document.body
				.querySelector(STARLIGHT.MENU_BUTTON)
				?.closest('nav')
				?.dispatchEvent(
					new KeyboardEvent('keyup', {
						key: 'Escape',
						code: 'Escape',
						charCode: 27,
						keyCode: 27,
						shiftKey: false,
						ctrlKey: false,
						altKey: false,
						metaKey: false,
					})
				);
		}
	}

	function markMainFrameForReplacementSwap(doc: Document) {
		doc.body.querySelector(STARLIGHT.MAIN_FRAME)?.setAttribute('data-vtbot-replace', 'main');
	}

	function setMainTransitionScope(e: TransitionBeforePreparationEvent) {
		if (!mainTransitionScope) return;
		setMainTransitionScope(document, mainTransitionScope);
		setMainTransitionScope(e.newDocument, mainTransitionScope);

		function setMainTransitionScope(doc: Document, value: string) {
			const main = doc.querySelector<HTMLElement>(STARLIGHT.MAIN_SECTION);
			main && (main.dataset.astroTransitionScope = value);
		}
	}

	function updateSidebar(e: TransitionBeforeSwapEvent) {
		const newSidebar = e.newDocument.querySelector(STARLIGHT.SIDEBAR);
		if (!newSidebar) {
			document.querySelector(STARLIGHT.SIDEBAR)?.remove();
		} else {
			const sidebar = document.querySelector(STARLIGHT.SIDEBAR);
			if (!sidebar) {
				document
					.querySelector(STARLIGHT.MAIN_FRAME)
					?.insertAdjacentElement('beforebegin', newSidebar);
			} else {
				if (replaceSidebarContent) {
					const oldContent = sidebar.querySelector(STARLIGHT.SIDEBAR_CONTENT);
					const newContent = newSidebar.querySelector(STARLIGHT.SIDEBAR_CONTENT);
					if (oldContent && newContent) {
						oldContent.replaceWith(newContent);
					} else {
						sidebar.replaceWith(newSidebar);
					}
				}
			}
		}
	}

	function updateLanguageSelector(doc: Document) {
		doc
			.querySelectorAll(STARLIGHT.LANGUAGE_SELECTOR)
			.forEach((el, idx) =>
				el.setAttribute('data-vtbot-replace', `vtbot-${STARLIGHT.LANGUAGE_SELECTOR}-${idx}`)
			);
	}

	/*--------------------------*/

	import {
		TRANSITION_BEFORE_PREPARATION,
		TRANSITION_BEFORE_SWAP,
		TransitionBeforePreparationEvent,
		TransitionBeforeSwapEvent,
		isTransitionBeforePreparationEvent,
		isTransitionBeforeSwapEvent,
	} from 'astro:transitions/client';

	document.addEventListener(TRANSITION_BEFORE_PREPARATION, (e) => {
		({ replaceSidebarContent, retainCurrentPageMarker, mainTransitionScope } = queryMarkers());

		if (isTransitionBeforePreparationEvent(e)) {
			const originalLoader = e.loader;
			e.loader = async () => {
				await originalLoader();
				afterLoader(e);
			};
		}
	});

	document.addEventListener(TRANSITION_BEFORE_SWAP, (e) => {
		if (isTransitionBeforeSwapEvent(e)) {
			const originalSwap = e.swap;
			e.swap = () => {
				originalSwap();
				afterSwap(e);
			};
		}
	});
</script>
